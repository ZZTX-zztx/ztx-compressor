<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZTX Ëß£ÂéãÂ∑•ÂÖ∑ | ÈáçÊûÑÁâà</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            padding: 25px;
            max-width: 500px;
            margin: 0 auto;
            font-family: system-ui, -apple-system, sans-serif;
            background: #f5f5f5;
        }
        .card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h2 {
            color: #2196F3;
            text-align: center;
            margin-bottom: 20px;
            font-size: 20px;
        }
        #ztx-file {
            width: 100%;
            padding: 18px;
            border: 2px dashed #ccc;
            border-radius: 8px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: border-color 0.3s;
        }
        #ztx-file:hover {
            border-color: #2196F3;
        }
        #file-container {
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 6px;
            margin-bottom: 15px;
            display: none;
        }
        .file-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }
        .file-name {
            color: #333;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 70%;
        }
        .download-btn {
            padding: 3px 8px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }
        #extract-btn {
            width: 100%;
            padding: 12px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
        }
        #extract-btn:active {
            background: #1976D2;
        }
        #status {
            margin-top: 12px;
            text-align: center;
            font-size: 13px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="card">
        <h2>üì¶ ZTX Ê†ºÂºèËß£ÂéãÂ∑•ÂÖ∑</h2>
        <input type="file" id="ztx-file" accept=".ztx">
        <div id="file-container"></div>
        <button id="extract-btn">Ëß£Êûê ZTX Êñá‰ª∂</button>
        <div id="status">ËØ∑ÈÄâÊã© .ztx ÂéãÁº©ÂåÖ</div>
    </div>

    <script src="https://cdn.bootcdn.net/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        // DOM ÂÖÉÁ¥†Ëé∑Âèñ
        const ztxFileInput = document.getElementById('ztx-file');
        const fileContainer = document.getElementById('file-container');
        const extractBtn = document.getElementById('extract-btn');
        const statusText = document.getElementById('status');
        
        let zipData = null; // Â≠òÂÇ®Ëß£ÊûêÂêéÁöÑ ZIP ÂÆû‰æã

        // ÁªëÂÆöÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
        extractBtn.addEventListener('click', parseZTXFile);

        // Ê†∏ÂøÉËß£ÊûêÂáΩÊï∞
        async function parseZTXFile() {
            const file = ztxFileInput.files[0];
            // Ê†°È™åÊñá‰ª∂
            if (!file) {
                showStatus('ËØ∑ÈÄâÊã©‰∏Ä‰∏™ .ztx Êñá‰ª∂', 'warning');
                return;
            }
            if (file.name.split('.').pop().toLowerCase() !== 'ztx') {
                showStatus('Êñá‰ª∂Ê†ºÂºèÈîôËØØÔºåËØ∑ÈÄâÊã© .ztx Êñá‰ª∂', 'error');
                return;
            }

            showStatus('Ê≠£Âú®Ëß£Êûê ZTX Êñá‰ª∂...', 'info');
            fileContainer.style.display = 'none';
            
            try {
                // ËØªÂèñÊñá‰ª∂Âπ∂Ëß£Êûê‰∏∫ ZIP
                const fileBuffer = await readFileToBuffer(file);
                zipData = await JSZip.loadAsync(fileBuffer);

                // È™åËØÅ ZTX Ê†áËØÜ
                const isZTX = zipData.files['ztx_identifier.txt'] !== undefined;
                if (isZTX) {
                    showStatus('‚úÖ Â∑≤ËØÜÂà´Ê†áÂáÜ ZTX ÂéãÁº©ÂåÖ', 'success');
                } else {
                    showStatus('‚ö†Ô∏è ÈùûÊ†áÂáÜ ZTX ÂåÖÔºåÂèØÂ∞ùËØïËß£Âéã', 'warning');
                }

                // Ê∏≤ÊüìÊñá‰ª∂ÂàóË°® - ÊîπÁî® forEach ÈÅçÂéÜÔºåÊõ¥Áõ¥ËßÇ
                renderFileList(zipData);

            } catch (err) {
                showStatus(`‚ùå Ëß£ÊûêÂ§±Ë¥•: ${err.message}`, 'error');
                console.error(err);
            }
        }

        // Ê∏≤ÊüìÊñá‰ª∂ÂàóË°®
        function renderFileList(zip) {
            fileContainer.innerHTML = '';
            fileContainer.style.display = 'block';

            // ÈÅçÂéÜ ZIP Êñá‰ª∂ÂàóË°®ÔºåËøáÊª§Êñá‰ª∂Â§πÂíåÊ†áËØÜÊñá‰ª∂
            Object.keys(zip.files).forEach(fileName => {
                const fileObj = zip.files[fileName];
                // Ë∑≥ËøáÊñá‰ª∂Â§πÂíå ZTX Ê†áËØÜÊñá‰ª∂
                if (fileObj.dir || fileName === 'ztx_identifier.txt') return;

                const fileSize = (fileObj._data.uncompressedSize / 1024).toFixed(1) + ' KB';
                const fileRow = document.createElement('div');
                fileRow.className = 'file-row';
                fileRow.innerHTML = `
                    <span class="file-name">${fileName}</span>
                    <div>
                        <span style="color:#999; font-size:12px; margin-right:8px">${fileSize}</span>
                        <button class="download-btn" onclick="downloadFile('${fileName}')">‰∏ãËΩΩ</button>
                    </div>
                `;
                fileContainer.appendChild(fileRow);
            });

            showStatus(`‚úÖ ÂÖ±Ëß£ÊûêÂá∫ ${fileContainer.children.length} ‰∏™Êñá‰ª∂`, 'success');
        }

        // ‰∏ãËΩΩÂçï‰∏™Êñá‰ª∂
        async function downloadFile(fileName) {
            if (!zipData) return;
            showStatus(`Ê≠£Âú®‰∏ãËΩΩ ${fileName}...`, 'info');

            try {
                const blob = await zipData.file(fileName).async('blob');
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                a.click();
                URL.revokeObjectURL(url);
                showStatus(`‚úÖ ${fileName} ‰∏ãËΩΩÂÆåÊàê`, 'success');
            } catch (err) {
                showStatus(`‚ùå ‰∏ãËΩΩÂ§±Ë¥•: ${err.message}`, 'error');
            }
        }

        // Â∑•ÂÖ∑ÂáΩÊï∞ÔºöËØªÂèñÊñá‰ª∂‰∏∫ ArrayBuffer
        function readFileToBuffer(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        // Â∑•ÂÖ∑ÂáΩÊï∞ÔºöÊòæÁ§∫Áä∂ÊÄÅ
        function showStatus(text, type) {
            statusText.textContent = text;
            const colorMap = {
                success: '#4CAF50',
                error: '#F44336',
                warning: '#FF9800',
                info: '#2196F3'
            };
            statusText.style.color = colorMap[type] || '#666';
        }
    </script>
</body>
</html>
