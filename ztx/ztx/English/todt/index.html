<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZTX Extraction Tool | Refactored</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            padding: 25px;
            max-width: 500px;
            margin: 0 auto;
            font-family: system-ui, -apple-system, sans-serif;
            background: #f5f5f5;
        }
        .card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h2 {
            color: #2196F3;
            text-align: center;
            margin-bottom: 20px;
            font-size: 20px;
        }
        #ztx-file {
            width: 100%;
            padding: 18px;
            border: 2px dashed #ccc;
            border-radius: 8px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: border-color 0.3s;
        }
        #ztx-file:hover {
            border-color: #2196F3;
        }
        #file-container {
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 6px;
            margin-bottom: 15px;
            display: none;
        }
        .file-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }
        .file-name {
            color: #333;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 70%;
        }
        .download-btn {
            padding: 3px 8px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }
        #extract-btn {
            width: 100%;
            padding: 12px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
        }
        #extract-btn:active {
            background: #1976D2;
        }
        #status {
            margin-top: 12px;
            text-align: center;
            font-size: 13px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="card">
        <h2>ðŸ“¦ ZTX Format Extraction Tool</h2>
        <input type="file" id="ztx-file" accept=".ztx">
        <div id="file-container"></div>
        <button id="extract-btn">Parse ZTX File</button>
        <div id="status">Please select a .ztx compressed package</div>
    </div>
    <script src="https://cdn.bootcdn.net/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        const ztxFileInput = document.getElementById('ztx-file');
        const fileContainer = document.getElementById('file-container');
        const extractBtn = document.getElementById('extract-btn');
        const statusText = document.getElementById('status');
        
        let zipData = null;
        
        extractBtn.addEventListener('click', parseZTXFile);
        
        async function parseZTXFile() {
            const file = ztxFileInput.files[0];
            if (!file) {
                showStatus('Please select a .ztx file', 'warning');
                return;
            }
            if (file.name.split('.').pop().toLowerCase() !== 'ztx') {
                showStatus('Invalid file format. Please select a .ztx file', 'error');
                return;
            }
            showStatus('Parsing ZTX file...', 'info');
            fileContainer.style.display = 'none';
            
            try {
                const fileBuffer = await readFileToBuffer(file);
                zipData = await JSZip.loadAsync(fileBuffer);
                
                const isZTX = zipData.files['ztx_identifier.txt'] !== undefined;
                if (isZTX) {
                    showStatus('âœ… Standard ZTX compressed package recognized', 'success');
                } else {
                    showStatus('âš ï¸ Non-standard ZTX package. Extraction attempt possible', 'warning');
                }
                
                renderFileList(zipData);
            } catch (err) {
                showStatus(`âŒ Parsing failed: ${err.message}`, 'error');
                console.error(err);
            }
        }
        
        function renderFileList(zip) {
            fileContainer.innerHTML = '';
            fileContainer.style.display = 'block';
            
            Object.keys(zip.files).forEach(fileName => {
                const fileObj = zip.files[fileName];
                if (fileObj.dir || fileName === 'ztx_identifier.txt') return;
                
                const fileSize = (fileObj._data.uncompressedSize / 1024).toFixed(1) + ' KB';
                const fileRow = document.createElement('div');
                fileRow.className = 'file-row';
                fileRow.innerHTML = `
                    <span class="file-name">${fileName}</span>
                    <div>
                        <span style="color:#999; font-size:12px; margin-right:8px">${fileSize}</span>
                        <button class="download-btn" onclick="downloadFile('${fileName}')">Download</button>
                    </div>
                `;
                fileContainer.appendChild(fileRow);
            });
            
            showStatus(`âœ… ${fileContainer.children.length} files parsed successfully`, 'success');
        }
        
        async function downloadFile(fileName) {
            if (!zipData) return;
            showStatus(`Downloading ${fileName}...`, 'info');
            try {
                const blob = await zipData.file(fileName).async('blob');
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                a.click();
                URL.revokeObjectURL(url);
                showStatus(`âœ… ${fileName} downloaded successfully`, 'success');
            } catch (err) {
                showStatus(`âŒ Download failed: ${err.message}`, 'error');
            }
        }
        
        function readFileToBuffer(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }
        
        function showStatus(text, type) {
            statusText.textContent = text;
            const colorMap = {
                success: '#4CAF50',
                error: '#F44336',
                warning: '#FF9800',
                info: '#2196F3'
            };
            statusText.style.color = colorMap[type] || '#666';
        }
    </script>
</body>
</html>
